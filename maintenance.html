<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kochi Metro - Maintenance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #60A5FA;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 min-h-screen">
    <div class="p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Maintenance Queue (2 columns) -->
                <div class="lg:col-span-2">
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
                        <h2 class="text-xl font-semibold text-white mb-4">Maintenance Queue</h2>
                        <div id="maintenanceQueue">
                            <div class="flex justify-center items-center py-8">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Side Panel -->
                <div class="space-y-4">
                    <!-- Maintenance Stats -->
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                        <h3 class="text-lg font-semibold text-white mb-3">Maintenance Stats</h3>
                        <div id="maintenanceStats">
                            <div class="flex justify-center items-center py-4">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team Availability -->
                    <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                        <h3 class="text-lg font-semibold text-white mb-3">Team Availability</h3>
                        <div id="teamAvailability">
                            <div class="flex justify-center items-center py-4">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAINTENANCE_API_URL = 'http://localhost:5003/api/urgent-maintenance';
        
        function getPriorityColor(priority) {
            switch (priority.toLowerCase()) {
                case 'critical': return 'bg-red-500/20 text-red-400';
                case 'high': return 'bg-orange-500/20 text-orange-400';
                case 'medium': return 'bg-yellow-500/20 text-yellow-400';
                case 'low': return 'bg-green-500/20 text-green-400';
                default: return 'bg-gray-500/20 text-gray-400';
            }
        }

        function getTeamStatusColor(status) {
            switch (status) {
                case 'Available': return 'bg-green-500/20 text-green-400';
                case 'Busy': return 'bg-red-500/20 text-red-400';
                case 'On Break': return 'bg-yellow-500/20 text-yellow-400';
                default: return 'bg-gray-500/20 text-gray-400';
            }
        }

        function formatTime(timeStr) {
            if (timeStr === 'Unscheduled') return 'Unscheduled';
            try {
                const date = new Date(timeStr);
                return date.toLocaleString('en-IN', { 
                    dateStyle: 'short', 
                    timeStyle: 'short' 
                });
            } catch (e) {
                return timeStr;
            }
        }

        function renderMaintenanceQueue(data) {
            const container = document.getElementById('maintenanceQueue');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">No urgent maintenance issues.</div>';
                return;
            }

            container.innerHTML = data.map((item, index) => `
                <div class="bg-white/5 rounded-xl p-4 border border-white/10 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                            </svg>
                            <div>
                                <h3 class="text-white font-medium">${item.id}</h3>
                                <p class="text-gray-300 text-sm">${item.issue}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getPriorityColor(item.priority)}">
                            ${item.priority}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-400">Scheduled:</span>
                            <div class="text-white">${formatTime(item.scheduled_time)}</div>
                        </div>
                        <div>
                            <span class="text-gray-400">Technician:</span>
                            <div class="text-white">${item.technician || 'N/A'}</div>
                        </div>
                        <div>
                            <span class="text-gray-400">Cost:</span>
                            <div class="text-white">₹${item.cost ? item.cost.toLocaleString() : 'N/A'}</div>
                        </div>
                        <div>
                            <span class="text-gray-400">Parts:</span>
                            <div class="text-white">${item.parts ? item.parts.join(', ') : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderMaintenanceStats(data) {
            const container = document.getElementById('maintenanceStats');
            
            const criticalCount = data.filter(m => m.priority === 'Critical').length;
            const highCount = data.filter(m => m.priority === 'High').length;
            const totalCost = data.reduce((sum, m) => sum + (m.cost || 0), 0);

            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Critical Issues</span>
                        <span class="text-red-400 font-medium">${criticalCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">High Priority</span>
                        <span class="text-orange-400 font-medium">${highCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Total Cost</span>
                        <span class="text-white font-medium">₹${totalCost.toLocaleString()}</span>
                    </div>
                </div>
            `;
        }

        function renderTeamAvailability(teamData) {
            const container = document.getElementById('teamAvailability');
            
            if (!teamData || Object.keys(teamData).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-sm">No team data available.</div>';
                return;
            }

            container.innerHTML = Object.entries(teamData).map(([team, statusData]) => `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-300">${team}</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${getTeamStatusColor(statusData.status)}">
                        ${statusData.status}
                    </span>
                </div>
            `).join('');
        }

        async function fetchMaintenanceData() {
            try {
                const response = await fetch(MAINTENANCE_API_URL);
                if (response.ok) {
                    const result = await response.json();
                    renderMaintenanceQueue(result.data);
                    renderMaintenanceStats(result.data);
                    renderTeamAvailability(result.team_availability);
                } else {
                    console.error('Failed to fetch maintenance data');
                    // Use mock data
                    useMockData();
                }
            } catch (error) {
                console.error('Error fetching maintenance data:', error);
                // Use mock data
                useMockData();
            }
        }

        function useMockData() {
            const mockData = [
                { id: 'KM002', issue: 'Brake System Failure', priority: 'Critical', scheduled_time: new Date(Date.now() + 2*60*60*1000).toISOString(), technician: 'Team A', cost: 15000, parts: ['Brake Pads', 'Hydraulic Fluid'] },
                { id: 'KM020', issue: 'Engine Overheating', priority: 'High', scheduled_time: new Date(Date.now() + 4*60*60*1000).toISOString(), technician: 'Team B', cost: 25000, parts: ['Radiator', 'Coolant'] },
                { id: 'KM012', issue: 'Door Mechanism', priority: 'High', scheduled_time: new Date(Date.now() + 3*60*60*1000).toISOString(), technician: 'Team C', cost: 8000, parts: ['Door Motor', 'Sensors'] },
                { id: 'KM006', issue: 'AC Unit Malfunction', priority: 'Medium', scheduled_time: new Date(Date.now() + 6*60*60*1000).toISOString(), technician: 'Team D', cost: 12000, parts: ['Compressor', 'Filter'] },
            ];

            const mockTeams = {
                'Team A': { status: 'Busy' },
                'Team B': { status: 'Available' },
                'Team C': { status: 'Busy' },
                'Team D': { status: 'Available' },
                'Team E': { status: 'On Break' },
                'Team F': { status: 'Available' }
            };

            renderMaintenanceQueue(mockData);
            renderMaintenanceStats(mockData);
            renderTeamAvailability(mockTeams);
        }

        // Load data on page load
        fetchMaintenanceData();

        // Refresh data every 30 seconds
        setInterval(fetchMaintenanceData, 30000);
    </script>
</body>
</html>